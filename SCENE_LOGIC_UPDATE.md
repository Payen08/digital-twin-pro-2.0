# 场景逻辑优化 - 新建 vs 更新

## 🎯 核心区别

### 1. 新建场景 (Create / Init)

**状态**: 场景是全新的，或是一张白纸

**数据**: 当前场景内没有任何设备模型、装饰物或绑定关系

**逻辑**: 系统直接读取上传的 JSON，把它"画"出来即可

**结果**: 
- ✅ 无复杂弹窗
- ✅ 直接显示导入后的结果
- ✅ 只有简单的加载进度提示

**触发条件**:
```javascript
// 1. 默认场景且场景干净
isDefaultScene && sceneIsClean

// 2. 明确标记为新建场景
isNewScene === true

// 3. 正式场景但没有路网实体
!isDefaultScene && !hasNetworkEntities
```

---

### 2. 更新场景 (Update / Merge)

**状态**: 场景里已经有了内容

**数据**: 
- 已配置的 3D 模型（如高精度机床）
- 自定义颜色和样式
- 装饰物（围栏、墙体等）
- 孪生点位绑定关系

**冲突**: 
- 用新路网彻底覆盖？→ 丢失所有配置（选项 B）
- 只更新坐标，保留配置？→ 智能合并（选项 A）

**结果**: 
- ⚠️ 必须弹出"保留绑定策略"对话框
- ⚠️ 让用户做决策，防止误操作导致数据丢失

**触发条件**:
```javascript
// 正式场景 + 有路网实体 + 标记为更新操作
!isDefaultScene && hasNetworkEntities && isNewScene === false
```

---

### 3. 特殊情况：默认场景有内容

**状态**: 用户在"默认场景"里随手画了一些墙或放了几个模型

**逻辑**: 简单的 Confirm/Cancel 提示

**弹窗文案**:
```
⚠️ 当前场景已有编辑内容

导入新地图将覆盖现有内容，是否继续？

• 点击"确定"：清空现有内容，导入新地图
• 点击"取消"：取消导入
```

**特点**:
- ✅ 简单的确认对话框
- ✅ 不是复杂的"保留绑定策略"选择器
- ✅ 只有覆盖/取消两个选项

---

## 📊 逻辑判断流程

```
handleMapImport(jsonContent, isNewScene)
    ↓
解析 JSON 数据
    ↓
判断场景状态
    ├─ 是新建场景？(isNewScene === true)
    │   ├─ 场景干净？
    │   │   ├─ 是 → 直接加载 ✅
    │   │   └─ 否 → 简单确认对话框 ⚠️
    │   └─ 用户确认 → 加载完成 ✅
    │
    └─ 是更新场景？(isNewScene === false)
        ├─ 有路网实体？(hasNetworkEntities)
        │   ├─ 是 → 弹出"保留绑定策略"对话框 ⚠️⚠️
        │   │   ├─ 选项 A：保留绑定（推荐）
        │   │   └─ 选项 B：完全覆盖（危险）
        │   └─ 否 → 直接加载 ✅
        └─ 完成
```

---

## 🔧 代码实现

### 核心判断逻辑

```javascript
const handleMapImport = useCallback(async (jsonContent, isNewScene = true) => {
    // 1. 解析数据
    const { baseMap, entities, paths } = parseFullMapJson(jsonContent);
    
    // 2. 判断状态
    const isDefaultScene = floors.length === 1 && floors[0].isDefault;
    const sceneIsClean = isSceneClean(objects);
    const hasNetworkEntities = objects.some(o => 
        o.sourceRefId && o.type === 'waypoint'
    );
    
    // 3. 场景 A: 新建场景
    if (isNewScene || isDefaultScene) {
        if (sceneIsClean) {
            // 直接加载
            loadScene(baseMap, entities, paths);
        } else {
            // 简单确认
            if (confirm('当前场景已有编辑内容，是否覆盖？')) {
                loadScene(baseMap, entities, paths);
            }
        }
        return;
    }
    
    // 4. 场景 B: 更新已有场景
    if (!isDefaultScene && hasNetworkEntities) {
        // 弹出复杂的"保留绑定策略"对话框
        showMergeDialog({ baseMap, entities, paths });
        return;
    }
    
    // 5. 场景 C: 正式场景但无路网实体（视为新建）
    loadScene(baseMap, entities, paths);
}, [objects, floors]);
```

### 调用方式

```javascript
// 新建场景
await handleMapImport(jsonData, true);  // isNewScene = true

// 更新路网
await handleMapImport(jsonData, false); // isNewScene = false
```

---

## 🎨 UI 设计

### 新建场景 - 无弹窗

```
📥 加载中...
    ↓
✅ 场景创建成功
地图: 1.5
点位: 15 个
路径: 8 条
```

### 默认场景有内容 - 简单确认

```
┌─────────────────────────────────┐
│ ⚠️ 当前场景已有编辑内容         │
│                                 │
│ 导入新地图将覆盖现有内容，      │
│ 是否继续？                      │
│                                 │
│        [取消]      [确定]       │
└─────────────────────────────────┘
```

### 更新已有场景 - 复杂策略选择

```
┌─────────────────────────────────────────┐
│ 🔄 更新路网数据                    ✕   │
├─────────────────────────────────────────┤
│ ⚠️ 检测到正在更新现有场景的路网数据    │
│ 新地图包含 15 个点位，8 条路径         │
│                                         │
│ 请选择更新策略：                        │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ A  保留孪生绑定          [推荐]    │ │
│ │    • 保留已配置的 3D 模型          │ │
│ │    • 仅更新点位坐标和角度          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ B  完全覆盖              [危险]    │ │
│ │    • 删除所有现有实体              │ │
│ │    • ⚠️ 此操作不可撤销             │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 📍 UI 入口

### 1. 新建场景入口

**位置**: 场景管理对话框

**按钮**: "新增场景"

**行为**: 
- 打开编辑场景对话框
- 选择地图 JSON
- 点击"确定" → `handleMapImport(json, true)`

### 2. 更新路网入口

**位置**: 编辑场景对话框（仅编辑已有场景时显示）

**按钮**: "更新路网" (黄色按钮)

**行为**:
- 点击"更新路网" → `handleMapImport(json, false)`
- 触发"保留绑定策略"对话框

---

## ✅ 测试场景

### 场景 1: 新建空白场景
```
1. 打开编辑器（默认场景）
2. 点击"默认场景" → 打开创建对话框
3. 选择地图 JSON
4. 点击"确定"
   ✅ 预期：直接加载，无复杂弹窗
```

### 场景 2: 默认场景有内容
```
1. 在默认场景中拖入几个模型
2. 点击"新增场景"
3. 选择地图 JSON
4. 点击"确定"
   ✅ 预期：简单确认对话框
   ✅ 文案："当前场景已有编辑内容，是否覆盖？"
```

### 场景 3: 更新已有场景
```
1. 已有场景（包含路网点位）
2. 点击"编辑场景"
3. 点击"更新路网"按钮
   ✅ 预期：弹出"保留绑定策略"对话框
   ✅ 选项 A：保留绑定（推荐）
   ✅ 选项 B：完全覆盖（危险）
```

### 场景 4: 正式场景但无路网实体
```
1. 正式场景（只有装饰物，无路网点位）
2. 导入新地图
   ✅ 预期：直接加载，视为新建
```

---

## 🎯 关键点总结

1. **新建场景** = 直接加载，体验流畅 ✅
2. **更新场景** = 保护劳动成果，防止误操作 ⚠️
3. **默认场景** = 简单确认，不复杂 ⚠️
4. **判断依据** = `isNewScene` + `hasNetworkEntities` 🔑
5. **UI 入口** = "新增场景" vs "更新路网" 🎨

---

**版本**: 2.1.0  
**最后更新**: 2025-11-24  
**实现状态**: ✅ 完成
