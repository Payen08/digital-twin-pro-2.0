# 产品需求文档 (PRD): Digital Twin Pro 2.0 编辑器

## 1. 概述 (Overview)

**产品名称**: Digital Twin Pro 2.0 Editor
**核心文件**: `src/App.jsx`

**背景**:
本项目是一个基于 Web 的 3D 数字孪生编辑器，旨在为用户提供一个直观、高效的界面，用于构建、编辑和管理室内场景的数字孪生模型。它集成了 SLAM 地图数据，支持多楼层管理，并提供丰富的 3D 建模和路径规划工具。

**目标**:
提供一个功能完备的 3D 编辑环境，支持从底图导入、场景构建（墙体、地面）、设备放置到路径规划的全流程操作，最终输出可用于机器人导航或监控系统的数字孪生数据。

## 2. 核心功能 (Core Features)

### 2.1 3D 场景与视图管理
*   **渲染引擎**: 基于 React Three Fiber (Three.js) 构建高性能 3D 场景。
*   **视图控制**:
    *   支持 **3D 透视视图 (Perspective)** 和 **2D 顶视图 (Top-down)** 切换。
    *   **轨道控制 (OrbitControls)**: 支持旋转、平移、缩放操作。
    *   **智能交互**: 实现了防误触机制，区分拖拽与点击操作。
*   **辅助工具**:
    *   **无限网格 (Infinite Grid)**: 提供空间参照。
    *   **坐标轴**: 显示世界坐标系原点及方向。
    *   **吸附功能 (Snap)**: 支持网格吸附和对象吸附，辅助精确对齐。

### 2.2 对象管理 (Object Management)
*   **对象类型**:
    *   **基础几何**: 墙体 (Wall)、地面 (Floor)、柱子 (Column)、门 (Door)。
    *   **复杂模型**: CNC 机床、自定义 GLB/GLTF 模型。
    *   **功能实体**: 点位 (Waypoint)、路径 (Path)、虚拟墙 (Virtual Wall)。
    *   **地图底图**: SLAM 导出的地图图片。
*   **基本操作**:
    *   **选择**: 单选、多选 (Shift+Click)、框选 (Box Selection)。
    *   **变换**: 移动 (Translate)、旋转 (Rotate)、缩放 (Scale)。
    *   **编辑**: 属性编辑、删除、锁定/解锁、显隐控制。
*   **批量操作**:
    *   支持框选多个对象进行统一移动、旋转或删除。
    *   提供对齐工具 (左对齐、居中、分布等)。

### 2.3 绘图与建模工具 (Drawing & Modeling)
*   **墙体绘制**:
    *   **直线墙**: 支持连续绘制直线墙段。
    *   **曲线墙**: 基于 Catmull-Rom 样条曲线绘制平滑墙体，支持控制点编辑。
*   **地面绘制**: 多边形地面绘制工具。
*   **路径规划**:
    *   **点位 (Waypoint)**: 创建导航点，支持类型标记 (充电点、停靠点等)。
    *   **路径连线**: 连接点位生成导航路径，支持单向/双向配置。

### 2.4 地图与楼层系统 (Map & Floor System)
*   **SLAM 集成**:
    *   支持导入 SLAM 系统导出的 JSON 地图数据。
    *   自动解析地图分辨率、原点坐标，并校准到 3D 场景中。
*   **多楼层管理**:
    *   支持多楼层数据的加载与切换。
    *   楼层数据的隔离与独立编辑。

### 2.5 资产管理 (Asset Management)
*   **资产库**: 提供内置资产列表 (CNC、货架、机器人等)。
*   **拖拽生成**: 支持从侧边栏直接拖拽资产到 3D 场景中生成实例。
*   **自定义资产**: 支持上传或配置自定义 GLB 模型，设置默认缩放和旋转参数。

## 3. 用户界面 (UI/UX)

### 3.1 工具栏 (Toolbar)
*   **顶部工具栏**: 包含文件操作 (导入/导出/保存)、编辑操作 (撤销/重做)、视图切换、吸附开关等全局功能。
*   **左侧工具栏**: 包含核心绘图工具 (选择、移动、旋转、画墙、画线、添加点位等)。

### 3.2 侧边栏 (Sidebar)
*   **资产面板**: 展示可用模型和组件，支持分类浏览。
*   **图层/大纲视图**: 以树状结构展示场景中的所有对象，支持快速选择和显隐控制。

### 3.3 属性面板 (Properties Panel)
*   **动态属性**: 根据当前选中对象的类型显示不同的属性表单。
    *   **基础属性**: 名称、ID、位置 (X/Y/Z)、旋转、缩放。
    *   **特有属性**: 颜色、透明度、墙体厚度/高度、点位类型等。
*   **实时更新**: 修改属性值实时反映在 3D 场景中。

### 3.4 快捷键支持
*   **通用**: Delete (删除), Ctrl+Z (撤销), Ctrl+Y (重做), Ctrl+S (保存)。
*   **视图**: Alt+Drag (旋转/平移切换), Space (平移模式)。
*   **编辑**: Shift+Click (多选/添加点), Esc (取消操作)。

## 4. 技术架构 (Technical Architecture)

### 4.1 技术栈
*   **框架**: React 18
*   **3D 引擎**: Three.js, React Three Fiber (@react-three/fiber)
*   **辅助库**: @react-three/drei (常用组件), lucide-react (图标), uuid (ID生成)

### 4.2 数据流
*   **状态管理**: 使用 React `useState` 和 `useRef` 管理场景对象列表 (`objects`)、选中状态 (`selectedId`)、操作模式 (`toolMode`) 等。
*   **持久化**: 支持将场景数据导出为 JSON 文件，包含所有对象的属性、拓扑关系和地图元数据。

### 4.3 性能优化
*   **按需渲染**: 使用 `useMemo` 和 `useCallback` 优化组件重渲染。
*   **实例渲染**: 对大量重复对象 (如点位) 可采用 InstancedMesh (待优化项)。
*   **资源加载**: 使用 `Suspense` 和异步加载器处理 3D 模型和纹理。

## 5. 假设与限制
*   **浏览器兼容性**: 需支持 WebGL 2.0 的现代浏览器 (Chrome, Edge, Firefox, Safari)。
*   **性能限制**: 场景对象数量过多 (如 >1000) 可能导致渲染帧率下降，需后续优化。
*   **文件格式**: 目前主要支持特定格式的 SLAM JSON 和标准 GLB/GLTF 模型。
