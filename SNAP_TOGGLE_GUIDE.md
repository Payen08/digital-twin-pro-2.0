# 吸附开关按钮使用指南

## 🎯 问题背景

**问题**: Alt 键方案可能因为浏览器焦点、系统快捷键冲突或操作习惯问题失效

**解决方案**: 在工具栏添加显式的"吸附开关"按钮，让用户可以随时点击切换

---

## 🎮 使用方式

### 工具栏按钮

在顶部工具栏中，找到 **磁铁图标 (🧲)** 按钮：

| 状态 | 图标颜色 | 光标颜色 | 说明 |
|------|---------|---------|------|
| 🔵 **开启** | 蓝色高亮 | 蓝色/绿色 | 启用网格吸附和对象吸附 |
| ⚪ **关闭** | 灰色 | 橙色 | 完全自由模式，指哪打哪 |

### 操作步骤

#### 方式 1: 点击按钮切换

```
1. 点击工具栏上的磁铁图标 🧲
2. 图标变灰 → 吸附关闭
3. 光标变橙色 🟠
4. 现在可以精确点击底图上的任意位置
5. 再次点击磁铁图标 → 恢复吸附
```

#### 方式 2: Alt 键临时切换（仍然保留）

```
1. 按住 Alt 键（Mac 上是 Option）
2. 临时反转当前吸附状态
3. 松开 Alt 键 → 恢复原状态
```

---

## 📊 三种模式对比

### 模式 1: 吸附开启 + 无对象

```
磁铁按钮: 🔵 蓝色
光标颜色: 🔵 蓝色
坐标行为: 对齐到网格点 (0.0, 0.5, 1.0...)
适用场景: 绘制规整的墙体、对齐网格
```

### 模式 2: 吸附开启 + 靠近对象

```
磁铁按钮: 🔵 蓝色
光标颜色: 🟢 绿色
坐标行为: 吸附到路径/设备
适用场景: 连接设备、沿路径绘制
```

### 模式 3: 吸附关闭

```
磁铁按钮: ⚪ 灰色
光标颜色: 🟠 橙色
坐标行为: 完全自由，真实坐标
适用场景: 描图、精确点击底图
```

---

## 🎨 视觉反馈

### 按钮状态

```javascript
// 开启状态
<button className="bg-blue-600 text-white shadow-lg">
    <Magnet size={18} strokeWidth={2.5} />
</button>

// 关闭状态
<button className="text-gray-500 hover:bg-[#333]">
    <Magnet size={18} strokeWidth={2} />
</button>
```

### 光标颜色

```javascript
光标颜色 = {
    吸附关闭 ? 🟠 橙色 :
    靠近对象 ? 🟢 绿色 :
              🔵 蓝色
}
```

---

## 💡 使用场景

### 场景 1: 描图（Trace）

**需求**: 沿着底图上的黑色线条绘制墙体

**操作**:
```
1. 点击磁铁按钮 → 关闭吸附（变灰）
2. 光标变橙色 🟠
3. 沿底图黑线精确点击
4. Enter 完成绘制
5. 点击磁铁按钮 → 恢复吸附（变蓝）
```

**效果**:
- ✅ 墙体完美贴合底图黑线
- ✅ 不受网格限制
- ✅ 指哪打哪

---

### 场景 2: 混合绘制

**需求**: 部分对齐网格，部分自由绘制

**操作**:
```
1. 磁铁开启 🔵 → 点击 (0, 0) → 网格吸附
2. 磁铁开启 🔵 → 点击 (5, 0) → 网格吸附
3. 点击磁铁关闭 ⚪ → 点击 (5.23, 2.45) → 自由模式
4. 点击磁铁开启 🔵 → 点击 (10, 5) → 网格吸附
5. Enter 完成
```

**效果**:
- ✅ 灵活切换
- ✅ 规整 + 自由结合
- ✅ 最佳体验

---

### 场景 3: 精确定位设备

**需求**: 设备位置不在网格点上（如 1.234, 2.567）

**操作**:
```
1. 点击磁铁按钮 → 关闭吸附
2. 光标变橙色 🟠
3. 点击精确位置
4. 点击磁铁按钮 → 恢复吸附
```

**效果**:
- ✅ 设备位置完全准确
- ✅ 不受网格限制

---

## 🔧 技术实现

### 状态管理

```javascript
// App 组件中
const [enableSnap, setEnableSnap] = useState(true); // 默认开启
```

### 按钮实现

```javascript
<button
    onClick={() => setEnableSnap(!enableSnap)}
    className={`p-2.5 rounded-lg transition-all duration-200 ${
        enableSnap 
            ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' 
            : 'text-gray-500 hover:bg-[#333] hover:text-gray-200'
    }`}
    title={`网格吸附: ${enableSnap ? '开' : '关'} (Alt键临时切换)`}
>
    <Magnet size={18} strokeWidth={enableSnap ? 2.5 : 2} />
</button>
```

### 吸附逻辑

```javascript
const handleMove = (e) => {
    // 判断是否需要吸附
    // 逻辑：如果开关开了，且没按Alt -> 吸附
    //       如果开关关了，且没按Alt -> 不吸附
    //       按住Alt -> 反转当前状态
    const shouldSnap = e.altKey ? !enableSnap : enableSnap;

    if (shouldSnap) {
        // 吸附模式：网格吸附 + 对象吸附
        bestPos = { x: snapToGrid(target.x), y: 0, z: snapToGrid(target.z) };
        // ... 对象吸附逻辑
    } else {
        // 自由模式：完全跟随鼠标
        bestPos = { x: target.x, y: 0, z: target.z };
    }
};
```

---

## 🎯 优势对比

### Alt 键方案

**优点**:
- ✅ 快捷键快速切换
- ✅ 无需点击按钮

**缺点**:
- ❌ 可能被系统快捷键占用
- ❌ 浏览器焦点问题
- ❌ 用户可能不知道有这个功能

### 按钮方案

**优点**:
- ✅ 显式可见，易发现
- ✅ 不受快捷键冲突影响
- ✅ 状态清晰（蓝色/灰色）
- ✅ 适合长时间描图

**缺点**:
- ❌ 需要点击操作

### 组合方案（当前实现）

**优点**:
- ✅ 结合两者优势
- ✅ 按钮 + Alt 键双重支持
- ✅ 适应不同用户习惯
- ✅ 最大灵活性

---

## ⚠️ 注意事项

### 1. 按钮位置

- 位于工具栏中间，"贴齐地面"按钮之后
- 与其他工具按钮保持一致的样式
- 易于发现和点击

### 2. 状态持久化

- 当前实现：状态不持久化，刷新后恢复默认（开启）
- 可选优化：使用 localStorage 保存用户偏好

### 3. Alt 键兼容性

- Windows: Alt 键
- Mac: Option 键
- 按住 Alt 时临时反转吸附状态
- 松开 Alt 恢复按钮状态

### 4. 性能考虑

- 自由模式下不进行吸附检测
- 性能最优，响应速度最快
- 适合大量点位的描图操作

---

## 📊 用户反馈

### 问题 1: "为什么我的鼠标无法对齐底图黑线？"

**原因**: 吸附开关开启，强制对齐网格

**解决**: 点击磁铁按钮关闭吸附，光标变橙色后即可精确点击

### 问题 2: "我想快速切换吸附状态"

**方案 1**: 点击磁铁按钮（永久切换）

**方案 2**: 按住 Alt 键（临时切换）

### 问题 3: "我不知道当前是否开启吸附"

**查看方式**:
- 看磁铁按钮颜色（蓝色=开启，灰色=关闭）
- 看光标颜色（橙色=自由模式，蓝色/绿色=吸附模式）

---

## 🎓 最佳实践

### 1. 规整绘制

```
保持磁铁开启 🔵 → 自动对齐网格 → 快速绘制规整图形
```

### 2. 描图操作

```
关闭磁铁 ⚪ → 沿底图精确点击 → 完成后恢复磁铁 🔵
```

### 3. 混合操作

```
根据需要随时切换磁铁状态 → 灵活应对各种场景
```

### 4. 快速微调

```
按住 Alt 临时切换 → 微调位置 → 松开 Alt 恢复
```

---

## 📚 相关文档

- `FREE_MODE_GUIDE.md` - 自由模式功能说明
- `SNAP_TO_PATH_GUIDE.md` - 完整的吸附逻辑实现指南
- `DATA_SOURCE_SHARING.md` - 数据源共享机制说明

---

**版本**: 1.0.0  
**最后更新**: 2025-11-24  
**实现状态**: ✅ 完成
