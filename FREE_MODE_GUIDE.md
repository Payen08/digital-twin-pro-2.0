# 自由模式功能说明

## 🎯 核心需求

**问题**: 用户需要"指哪打哪"的自由模式，而不是被迫"对齐网格"

**场景**: 
- 描图时需要精确点击底图上的墙体线条（如坐标 0.23）
- 底图上的线条不在网格点上（网格点是 0.0, 0.5, 1.0）
- 强制网格吸附导致无法精确对齐

**解决方案**: 按住 **Alt 键**（Mac 上是 **Option 键**）时，禁用一切吸附，鼠标指哪里就是哪里

---

## 🎮 操作方式

### 三种模式对比

| 模式 | 触发方式 | 光标颜色 | 坐标精度 | 适用场景 |
|------|---------|---------|---------|---------|
| 🔵 **网格吸附** | 默认 | 蓝色 | 0.5m 网格 | 绘制规整的墙体 |
| 🟢 **点/线吸附** | 靠近路径 | 绿色 | 精确到路径 | 连接设备、沿路径绘制 |
| 🟠 **自由模式** | 按住 Alt | 橙色 | 完全自由 | 描图、精确点击底图 |

---

## 📊 使用示例

### 场景 1: 描图（Trace）

**需求**: 沿着底图上的黑色线条绘制墙体

**问题**: 黑线坐标是 (1.23, 0, 2.45)，但网格只能对齐到 (1.0, 0, 2.5)

**解决**:
```
1. 选择"绘制墙体"工具
2. 按住 Alt 键（光标变橙色 🟠）
3. 鼠标移动到黑线上
4. 点击（精确记录 1.23, 0, 2.45）
5. 继续沿黑线点击
6. 松开 Alt 键（恢复网格吸附）
7. Enter 完成绘制
```

**效果**: 
- ✅ 墙体完美贴合底图黑线
- ✅ 不受网格限制
- ✅ 指哪打哪

---

### 场景 2: 混合使用

**需求**: 部分对齐网格，部分自由绘制

**操作**:
```
1. 点击 (0, 0) → 网格吸附 🔵
2. 点击 (5, 0) → 网格吸附 🔵
3. 按住 Alt，点击 (5.23, 2.45) → 自由模式 🟠
4. 松开 Alt，点击 (10, 5) → 网格吸附 🔵
5. Enter 完成
```

**效果**:
- ✅ 灵活切换
- ✅ 规整 + 自由结合
- ✅ 最佳体验

---

## 🔧 技术实现

### 核心代码

```javascript
const handleMove = (e) => {
    // 检测 Alt 键状态
    const isFreeMode = e.altKey;
    
    // 根据模式选择坐标
    let bestPos = isFreeMode 
        ? { x: target.x, y: 0, z: target.z }           // 🟠 自由模式：真实坐标
        : { x: snapToGrid(target.x), y: 0, z: snapToGrid(target.z) }; // 🔵 网格模式
    
    // 仅在非自由模式下启用对象吸附
    if (!isFreeMode) {
        // ... 点吸附逻辑
        // ... 线吸附逻辑
    }
    
    setMousePos(bestPos);
    setIsFreeMode(isFreeMode);
};
```

### 视觉反馈

```javascript
<meshBasicMaterial 
    color={
        isFreeMode ? "#f97316" :      // 🟠 橙色：自由模式
        isSnapped ? "#4ade80" :       // 🟢 绿色：点/线吸附
        "#3b82f6"                     // 🔵 蓝色：网格吸附
    }
/>
```

---

## 🎨 用户体验

### 操作流程

```
普通绘制
    ↓
鼠标移动 → 自动对齐网格 → 光标蓝色 🔵
    ↓
靠近路径 → 自动吸附路径 → 光标绿色 🟢
    ↓
按住 Alt → 禁用吸附 → 光标橙色 🟠
    ↓
松开 Alt → 恢复吸附 → 光标蓝色/绿色
```

### 视觉提示

| 光标颜色 | 模式 | 说明 |
|---------|------|------|
| 🔵 蓝色 | 网格吸附 | 坐标对齐到 0.5m 网格 |
| 🟢 绿色 | 点/线吸附 | 已锁定到路径或设备 |
| 🟠 橙色 | 自由模式 | 完全自由，指哪打哪 |

---

## 💡 使用技巧

### 1. 描图技巧

```
按住 Alt → 沿底图黑线点击 → 松开 Alt → Enter
```

**优势**:
- ✅ 精确贴合底图
- ✅ 不受网格限制
- ✅ 快速完成描图

### 2. 微调技巧

```
先用网格吸附大致定位 → 按住 Alt 微调 → 松开 Alt
```

**优势**:
- ✅ 快速定位
- ✅ 精确微调
- ✅ 最佳效率

### 3. 混合模式

```
规整部分用网格 → 不规则部分按 Alt → 灵活切换
```

**优势**:
- ✅ 规整 + 自由结合
- ✅ 适应复杂场景
- ✅ 最大灵活性

---

## ⚠️ 注意事项

### 1. Alt 键冲突

**问题**: 某些系统快捷键可能占用 Alt 键

**解决**: 
- Mac: 使用 Option 键
- Windows: 使用 Alt 键
- 如有冲突，可修改为其他键（如 Shift）

### 2. 精度控制

**问题**: 自由模式下坐标可能过于精确（如 1.234567）

**建议**:
- 适当使用网格吸附
- 混合使用三种模式
- 根据需求选择精度

### 3. 性能考虑

**问题**: 自由模式下不进行吸附检测，性能最优

**优势**:
- ✅ 无需计算吸附
- ✅ 响应速度最快
- ✅ 适合大量点位

---

## 🎯 应用场景

### 场景 1: 工业厂房描图

```
需求：根据 CAD 底图绘制墙体
方案：按住 Alt，沿 CAD 线条精确点击
效果：墙体完美贴合 CAD 图纸
```

### 场景 2: 不规则区域

```
需求：绘制不规则的禁行区
方案：按住 Alt，自由点击边界点
效果：精确描绘不规则形状
```

### 场景 3: 精确定位设备

```
需求：设备位置不在网格点上
方案：按住 Alt，点击精确位置
效果：设备位置完全准确
```

---

## 📊 对比分析

### 吸附前（只有网格吸附）

```
底图黑线: (1.23, 0, 2.45)
网格点:   (1.0, 0, 2.5)
结果:     ❌ 偏差 0.23m，无法对齐
```

### 吸附后（点/线吸附）

```
底图黑线: (1.23, 0, 2.45)
吸附结果: (1.23, 0, 2.45)
结果:     ✅ 完美对齐（如果黑线是矢量路径）
```

### 自由模式（按住 Alt）

```
底图黑线: (1.23, 0, 2.45)
点击位置: (1.23, 0, 2.45)
结果:     ✅ 完美对齐（无论是否是矢量）
```

---

## 🔑 关键优势

### 1. 灵活性 ✅

- 三种模式自由切换
- 适应各种绘制需求
- 最大化用户控制

### 2. 精确性 ✅

- 自由模式完全精确
- 不受网格限制
- 指哪打哪

### 3. 效率性 ✅

- 快捷键快速切换
- 无需菜单操作
- 流畅的绘制体验

### 4. 直观性 ✅

- 光标颜色实时反馈
- 三种颜色清晰区分
- 易学易用

---

## 📚 相关文档

- `SNAP_TO_PATH_GUIDE.md` - 完整的吸附逻辑实现指南
- `DATA_SOURCE_SHARING.md` - 数据源共享机制说明
- `SCENE_LOGIC_UPDATE.md` - 场景逻辑优化说明

---

**版本**: 1.0.0  
**最后更新**: 2025-11-24  
**实现状态**: ✅ 完成
